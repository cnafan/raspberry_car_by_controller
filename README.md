### 智能遥控小车（树莓派3B + TB6612FNG + 手柄 + 网页控制）

## 概述

这是一个基于树莓派3B的智能遥控小车项目。它提供了两种控制方式：

1. **USB/蓝牙手柄**：用于实时、高精度的物理控制。

2. **网页端**：提供直观的按钮遥控和实时状态显示。

项目采用 FastAPi 异步框架，结合 WebSocket 技术实现高效、低延迟的双向通信，确保手柄和网页端的控制指令能够快速响应，并且小车状态能实时同步。

## 架构

核心思想是**状态驱动**和**控制显示解耦**：

- **输入层**：手柄和网页端的控制指令高频地更新一个线程安全的全局状态 (`CarState`)。

- **核心状态**：`CarState` 作为唯一数据源，维护小车的当前方向、速度和控制来源。

- **输出层**：独立的线程/协程周期性地读取 `CarState`，并驱动电机或通过 WebSocket 广播给前端。

这种设计有效避免了输入事件和输出操作的直接耦合，保证了系统的稳定性和性能。

## 项目目录结构

```
car_project/
├── raspberry_car_by_controller/
│   ├── main.py             # FastAPI 应用入口
│   ├── routes.py           # HTTP / WebSocket 路由
│   ├── ws_manager.py       # WebSocket 连接管理器
│   ├── car_state.py        # 线程安全的全局状态
│   ├── motor_controller.py # 电机驱动逻辑
│   ├── joystick_handler.py # 手柄事件监听
│   └── config.py           # 配置（GPIO引脚等）
│
├── static/
│   └── index.html          # 网页控制界面
│
└── requirements.txt        # Python 依赖
```

## 安装与运行

1. **硬件连接**：
   
   - 将 TB6612FNG 驱动板连接到树莓派的指定 GPIO 引脚。
   
   - 连接直流电机。
   
   - 将 USB 或蓝牙手柄与树莓派配对。

2. **软件环境**：
   
   - 确保您的树莓派已安装 Python 3.7+。
   
   - 安装项目依赖：
     
     ```
     pip install -r requirements.txt
     ```
   
   - **特别注意**：由于 `pigpio` 等库需要特定的 GPIO 权限，可能需要以 `sudo` 运行。

3. **运行项目**：
   
   - 在项目根目录下，使用 `uvicorn` 启动服务：
     
     ```
     uvicorn app.main:app --host 0.0.0.0 --port 80
     ```
   
   - `- -host 0.0.0.0` 允许从任何 IP 地址访问。
   
   - `- -port 80` 在 80 端口运行，便于通过浏览器直接访问。

4. **访问控制页面**：
   
   - 在同一局域网下的任一设备上，打开浏览器并访问 `http://<树莓派IP地址>`。

## 网页控制说明

- 打开页面后，如果 WebSocket 连接成功，状态灯将变为绿色。

- 点击或长按方向按钮可控制小车。

- 手柄操作时，页面上的状态显示将实时更新，以反映手柄的控制。
